<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сканер уязвимостей</title>
    <!-- Подключение Bootstrap -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        .container-fluid {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .flex-grow-1 {
            flex-grow: 1;
        }

        .h-100 {
            height: 100%;
        }
    </style>
</head>

<body>
    <div class="container-fluid mt-4 d-flex flex-column min-vh-100">
        <!-- Заголовок -->
        <div class="row">
            <div class="col-8">
                <h1>Название</h1>
            </div>
            <div class="col-4">
                <form id="inputKeyForm">
                    <div class="row">
                        <div class="col-8">
                            <input type="text" class="form-control" id="apiKeyInput"
                                aria-describedby="passwordHelpBlock" name="apiKey" placeholder="Ввод API ключа">
                        </div>
                        <div class="col-4">
                            <button type="submit" id="submitButton" class="btn btn-success">Сохранить</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Ввод ссылки -->
        <form onsubmit="submitForm(event)" method="get">
            <div class="row align-items-center mt-3">
                <div class="col-4">
                    <input type="text" class="form-control" placeholder="Введите ссылку на сайт"
                        aria-label="Введите ссылку на сайт" name="url" aria-describedby="button-addon2" id="inputUrl">
                </div>
                <div class="col-2">
                    <button class="btn btn-outline-secondary" type="submit" id="submitButton">Старт</button>
                </div>
            </div>
        </form>

        <!-- Контент -->
        <div class="row mt-3">
            <!-- Блок 1: Ссылки и прогрессбар -->
            <div class="col-6">
                <!-- Прогрессбар -->
                <div class="progress mb-3">
                    <div id="progress-bar" class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100"
                        style="width: 0%;" aria-valuenow="0"></div>
                </div>
                <!-- Вывод ссылок -->
                <div class="border p-2" style="height: 600px; overflow-y: scroll;">
                    <table class="table" id="t_table">
                        <thead>
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">Processed</th>
                                <th scope="col">Status Reason</th>
                                <th scope="col">Method</th>
                                <th scope="col">Reason Not Processed</th>
                                <th scope="col">Message Id</th>
                                <th scope="col">Url</th>
                                <th scope="col">Status Code</th>
                            </tr>
                        </thead>
                        <tbody id="tbody">

                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Блоки 2 и 3: Уязвимости и подробности -->
            <div class="col-6">
                <!-- Блок 2: Уязвимости -->
                <div class="border p-2 mb-3" style="height: 300px; overflow-y: scroll;">
                    <h5>Уязвимости</h5>
                    <ul id="vulnerability-list" class="list-unstyled">
                        <!-- Уязвимости будут добавляться сюда через JavaScript -->
                    </ul>
                </div>

                <!-- Блок 3: Подробная информация об уязвимости -->
                <div class="border p-2" style="height: 300px;">
                    <h5>Подробная информация об уязвимости</h5>
                    <p id="vulnerability-details">Здесь будет выводиться информация о выбранной уязвимости.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Подключение Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>


    <script>
        document.getElementById('inputKeyForm').addEventListener('submit', async function (event) {
            event.preventDefault(); // Отменяем стандартное поведение отправки формы

            const submitButton = document.getElementById('submitButton');
            submitButton.disabled = true; // Блокируем кнопку

            const apiKey = document.getElementById('apiKeyInput').value;

            try {
                const response = await fetch('/addKey', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({ apiKey }),
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('API ключ успешно сохранен');
                    // Если нужно, можно обновить страницу или сделать что-то ещё
                } else {
                    const error = await response.json();
                    alert('Ошибка: ' + error.error);
                }
            } catch (err) {
                console.error('Ошибка запроса:', err);
                alert('Не удалось сохранить API ключ');
            } finally {
                submitButton.disabled = false; // Разблокировать кнопку
            }
        });

        function submitForm(event) {
            event.preventDefault();

            const submitButton = document.getElementById('submitButton');
            submitButton.disabled = true;

            const inputUrlElement = document.getElementById('inputUrl');
            const urlValue = inputUrlElement.value;
            const evenSourceUrl = 'scan?url=' + encodeURIComponent(urlValue);

            const eventSource = new EventSource(evenSourceUrl);

            const alertEventSource = new EventSource('/alerts');

            eventSource.addEventListener('progress', function (event) {
                const data = JSON.parse(event.data);

                console.log('Received progress event:', data);

                if (data.progressPercentage != "0") {
                    progressBar(data);
                    console.log('Updating progress bar...');
                }

                if (data.completed == true) {
                    closeEventStream();
                    console.log('Scan completed.');
                }
            });

            eventSource.addEventListener('results', function (event) {
                const data = JSON.parse(event.data);
                // console.log('New data: ', data)
                table(data)
            });

            alertEventSource.addEventListener("alerts", function (event) {
                const data = JSON.parse(event.data);
                addVulnerability(data)
            })

            eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('Received message:', data);
            };

            eventSource.onerror = (error) => {
                console.error('SSE error:', error);
            };

            // Either this or the one above
            eventSource.addEventListener('error', (error) => {
                console.error('SSE error:', error);
            });

            eventSource.onopen = () => {
                console.log('SSE connection opened');
            };

            eventSource.onclose = () => {
                console.log('SSE connection closed');
            };

            alertEventSource.onerror = (error) => {
                console.error('Alerts SSE error:', error);
            };

            alertEventSource.onopen = () => {
                console.log('Alerts SSE connection opened');
            };

            function closeEventStream() {
                console.log('Closing event stream...');
                submitButton.disabled = false;
                eventSource.close();
            }

            function progressBar(data) {
                // Get the progress bar element
                const progressBar = document.getElementById('progress-bar');
                progressBar.style.width = `${data.progressPercentage}%`;

                console.log('Updating progress bar:', data.progressPercentage);
            }

            function table(data) {
                const tbody = document.getElementById('tbody');
                const newRow = document.createElement('tr');

                newRow.innerHTML = `
            <th scope="row">${tbody.childElementCount + 1}</th>
            <td>${data.processed}</td>
            <td>${data.statusReason}</td>
            <td>${data.method}</td>
            <td>${data.reasonNotProcessed}</td>
            <td>${data.messageId}</td>
            <td>${data.url}</td>
            <td>${data.statusCode}</td>
        `;

                tbody.appendChild(newRow);
            }

            function addVulnerability(data) {
                const vulnerabilityList = document.getElementById('vulnerability-list');

                // Проверка наличия секции для текущего уровня риска
                let riskSection = document.getElementById(`risk-${data.risk}`);
                if (!riskSection) {
                    riskSection = document.createElement('li');
                    riskSection.id = `risk-${data.risk}`;
                    riskSection.innerHTML = `<a href="#!" data-toggle="collapse" data-target="#list-${data.risk}">${data.risk}</a>
                                     <ul id="list-${data.risk}" class="collapse list-unstyled ml-4"></ul>`;
                    vulnerabilityList.appendChild(riskSection);
                }

                const riskList = document.getElementById(`list-${data.risk}`);

                let vulnItem = document.getElementById(`vuln-${data.risk}-${data.name}`);
                if (!vulnItem) {
                    vulnItem = document.createElement('li');
                    vulnItem.id = `vuln-${data.risk}-${data.name}`;
                    vulnItem.innerHTML = `<a href="#!" data-toggle="collapse" data-target="#details-${data.risk}-${data.name}">${data.name}</a>
                                  <ul id="details-${data.risk}-${data.name}" class="collapse list-unstyled ml-4"></ul>`;
                    riskList.appendChild(vulnItem);
                }

                const vulnDetailsList = document.getElementById(`details-${data.risk}-${data.name}`);

                // Проверка на дублирование элемента для данного URL и метода
                
                let lastVuln = document.getElementById(`vuln-${data.method}-${data.url}`)
                if (!lastVuln) {
                    const lastVuln = document.createElement('li');
                    lastVuln.id = `${data.method}-${data.url}`;
                    lastVuln.innerHTML = `<a href="#!" data-toggle="collapse" data-target="#lastVuln-${data.method}-${data.url}">${data.method} ${data.url}</a>`;
                    vulnDetailsList.appendChild(lastVuln);
                }
                // data.commonAlert.forEach(alert => {
                //     const existingAlert = Array.from(vulnDetailsList.children).find(item =>
                //         item.dataset.url === alert.URL && item.dataset.method === alert.Method
                //     );

                //     if (!existingAlert) {
                //         const alertItem = document.createElement('li');
                //         alertItem.dataset.url = alert.URL;
                //         alertItem.dataset.method = alert.Method;
                //         alertItem.textContent = `${alert.Method} - ${alert.URL}`;
                //         vulnDetailsList.appendChild(alertItem);
                //     }
                // });
            }
        }


    </script>
</body>

</html>